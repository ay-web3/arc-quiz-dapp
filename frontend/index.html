<!DOCTYPE html>
<html>
<head>
  <title>Arc Quiz Rewards DApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Poppins, sans-serif;
      background: #f4f6f8;
      padding: 30px;
    }
    .app {
      max-width: 700px;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      margin: auto;
    }
    button {
      padding: 12px;
      width: 100%;
      margin-top: 10px;
      border-radius: 25px;
      background: #6a0dad;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .quiz-box {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }
    #leaderboardList li {
      margin: 6px 0;
    }
  </style>
</head>

<body>
<div class="app">
  <h2>Arc Reward Quiz</h2>

  <div id="serverBalance">Loading...</div>
  <button id="connectBtn">Connect Wallet</button>
  <p id="status">Disconnected</p>

  <div id="quiz"></div>
  <button id="submitBtn">Submit Page</button>

  <hr>
  <h3>üèÜ Leaderboard</h3>
  <p>Total Participants: <b id="participants">0</b></p>
  <ul id="leaderboardList"></ul>
</div>

<script>
const BACKEND = "http://localhost:3000";
const QUESTIONS_PER_PAGE = 4;

let account;
let quiz = [];
let page = 1;

function truncate(a){return a.slice(0,6)+"..."+a.slice(-4)}

async function loadBalance(){
  const r = await fetch(`${BACKEND}/balance`);
  const d = await r.json();
  document.getElementById("serverBalance").innerHTML =
    `Reward Pool: <b>${d.usdc} USDC</b><br><small>Native Gas: ${d.native} USDC</small>`;
}

async function loadQuiz(){
  const r = await fetch(`${BACKEND}/quiz`);
  quiz = await r.json();
  render();
}

function render(){
  const start = (page-1)*QUESTIONS_PER_PAGE;
  const end = Math.min(start+QUESTIONS_PER_PAGE, quiz.length);
  const box = document.getElementById("quiz");
  box.innerHTML = `<h3>Page ${page}</h3>`;

  quiz.slice(start,end).forEach((q,i)=>{
    box.innerHTML += `
      <div class="quiz-box">
        <b>${q.question}</b>
        ${q.options.map(o=>`
          <label><input type="radio" name="q${start+i}" value="${o}"> ${o}</label>
        `).join("<br>")}
      </div>
    `;
  });
}

document.getElementById("submitBtn").onclick = async ()=>{
  const start = (page-1)*QUESTIONS_PER_PAGE;
  const end = Math.min(start+QUESTIONS_PER_PAGE, quiz.length);

  for(let i=start;i<end;i++){
    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    if(selected && selected.value === quiz[i].answer){
      await fetch(`${BACKEND}/reward`,{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({userAddress:account,questionIndex:i})
      });
    }
  }

  page++;
  if(start >= quiz.length) return;
  render();
  loadLeaderboard();
};

async function loadLeaderboard(){
  const r = await fetch(`${BACKEND}/leaderboard`);
  const d = await r.json();
  document.getElementById("participants").innerText = d.participants;
  const list = document.getElementById("leaderboardList");
  list.innerHTML="";
  d.leaderboard.slice(0,10).forEach((e,i)=>{
    list.innerHTML += `<li>#${i+1} ${truncate(e.address)} ‚Äî ${e.reward} USDC</li>`;
  });
}

document.getElementById("connectBtn").onclick = async ()=>{
  const acc = await window.ethereum.request({method:"eth_requestAccounts"});
  account = acc[0];
  document.getElementById("status").innerText = "Connected: "+truncate(account);
};

loadBalance();
loadQuiz();
loadLeaderboard();
</script>
</body>
</html>
