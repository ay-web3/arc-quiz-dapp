<!DOCTYPE html>
<html>
<head>
  <title>Arc Quiz Rewards DApp</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

  <style>
    body {
      font-family: Poppins, sans-serif;
      background: #f4f6f8;
      padding: 30px;
    }
    .app {
      max-width: 700px;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    button {
      padding: 12px;
      width: 100%;
      margin-top: 10px;
      border-radius: 25px;
      background: #6a0dad;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      background: #bbb;
      cursor: not-allowed;
    }
    .quiz-box {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }
    #leaderboardList li {
      margin: 6px 0;
    }
    .success {
      background: #e8fff1;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-weight: 600;
    }
  </style>
</head>

<body>
<div class="app">
  <h2>Arc Reward Quiz</h2>

  <div id="serverBalance">Loading...</div>

  <button id="connectBtn">Connect Wallet</button>
  <p id="status">Disconnected</p>

  <div id="quiz"></div>
  <button id="submitBtn" disabled>Submit Page</button>

  <div id="finalMessage"></div>

  <hr>

  <h3>üèÜ Leaderboard</h3>
  <p>Total Participants: <b id="participants">0</b></p>
  <ul id="leaderboardList"></ul>
</div>

<script>
/* ================= CONFIG ================= */

const BACKEND = "https://arc-quiz-dapp.onrender.com";
const QUESTIONS_PER_PAGE = 4;
const REWARD_PER_QUESTION = 0.2;

/* ================= STATE ================= */

let account = null;
let quiz = [];
let page = 1;
let totalEarned = 0;

/* ================= HELPERS ================= */

function truncate(addr) {
  return addr.slice(0, 6) + "..." + addr.slice(-4);
}

function saveProgress() {
  localStorage.setItem(`arcQuiz_${account}`, JSON.stringify({
    page,
    totalEarned
  }));
}

function loadProgress() {
  const data = localStorage.getItem(`arcQuiz_${account}`);
  if (data) {
    const parsed = JSON.parse(data);
    page = parsed.page;
    totalEarned = parsed.totalEarned;
  }
}

/* ================= LOAD BALANCE ================= */

async function loadBalance() {
  try {
    const r = await fetch(`${BACKEND}/balance`);
    const d = await r.json();
    document.getElementById("serverBalance").innerHTML =
      `Reward Pool: <b>${d.usdc} USDC</b><br>
       <small>Native Gas: ${d.native} USDC</small>`;
  } catch {
    document.getElementById("serverBalance").innerText =
      "Backend Connection Error";
  }
}

/* ================= LOAD QUIZ ================= */

async function loadQuiz() {
  const r = await fetch(`${BACKEND}/quiz`);
  quiz = await r.json();
  renderQuiz();
}

/* ================= RENDER QUIZ ================= */

function renderQuiz() {
  document.getElementById("submitBtn").disabled = false;

  const start = (page - 1) * QUESTIONS_PER_PAGE;
  const end = Math.min(start + QUESTIONS_PER_PAGE, quiz.length);

  if (start >= quiz.length) {
    finishQuiz();
    return;
  }

  const box = document.getElementById("quiz");
  box.innerHTML = `<h3>Page ${page}</h3>`;

  quiz.slice(start, end).forEach((q, i) => {
    box.innerHTML += `
      <div class="quiz-box">
        <b>${q.question}</b><br><br>
        ${q.options.map(o => `
          <label>
            <input type="radio" name="q${start + i}" value="${o}">
            ${o}
          </label>
        `).join("<br>")}
      </div>
    `;
  });
}

/* ================= SUBMIT ================= */

document.getElementById("submitBtn").onclick = async () => {
  document.getElementById("submitBtn").disabled = true;

  const start = (page - 1) * QUESTIONS_PER_PAGE;
  const end = Math.min(start + QUESTIONS_PER_PAGE, quiz.length);

  for (let i = start; i < end; i++) {
    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    if (!selected) continue;

    if (selected.value === quiz[i].answer) {
      await fetch(`${BACKEND}/reward`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userAddress: account,
          questionIndex: i
        })
      });
      totalEarned += REWARD_PER_QUESTION;
    }
  }

  page++;
  saveProgress();
  renderQuiz();
  loadLeaderboard();
  loadBalance();
};

/* ================= FINISH ================= */

function finishQuiz() {
  document.getElementById("quiz").innerHTML = "";
  document.getElementById("submitBtn").style.display = "none";

  document.getElementById("finalMessage").innerHTML = `
    <div class="success">
      üéâ Congratulations! <br>
      You completed the quiz and earned <b>${totalEarned.toFixed(2)} USDC</b>
    </div>
  `;
}

/* ================= LEADERBOARD ================= */

async function loadLeaderboard() {
  const r = await fetch(`${BACKEND}/leaderboard`);
  const d = await r.json();

  document.getElementById("participants").innerText = d.participants;

  const list = document.getElementById("leaderboardList");
  list.innerHTML = "";

  d.leaderboard.slice(0, 10).forEach((e, i) => {
    list.innerHTML +=
      `<li>#${i + 1} ${truncate(e.address)} ‚Äî ${e.reward} USDC</li>`;
  });
}

/* ================= WALLET ================= */

document.getElementById("connectBtn").onclick = async () => {
  if (!window.ethereum) {
    alert("Please install MetaMask");
    return;
  }

  const accs = await window.ethereum.request({
    method: "eth_requestAccounts"
  });

  account = accs[0];
  loadProgress();

  document.getElementById("status").innerText =
    "Connected: " + truncate(account);

  document.getElementById("connectBtn").disabled = true;
  document.getElementById("submitBtn").disabled = false;

  loadQuiz();
};

/* ================= INIT ================= */

loadBalance();
loadLeaderboard();
</script>
</body>
</html>
