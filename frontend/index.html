<!DOCTYPE html>
<html>
<head>
  <title>Arc Quiz Rewards DApp</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

  <style>
    body {
      font-family: Poppins, sans-serif;
      background: #f4f6f8;
      padding: 30px;
    }
    .app {
      max-width: 700px;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    button {
      padding: 12px;
      width: 100%;
      margin-top: 10px;
      border-radius: 25px;
      background: #6a0dad;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      background: #bbb;
      cursor: not-allowed;
    }
    .quiz-box {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }
    #leaderboardList li {
      margin: 6px 0;
    }
  </style>
</head>

<body>
<div class="app">
  <h2>Arc Reward Quiz</h2>

  <div id="serverBalance">Loading...</div>

  <button id="connectBtn">Connect Wallet</button>
  <p id="status">Disconnected</p>

  <!-- QUIZ (HIDDEN UNTIL CONNECT) -->
  <div id="quizSection" style="display:none">
    <div id="quiz"></div>
    <button id="submitBtn">Submit Page</button>
  </div>

  <hr>

  <h3>üèÜ Leaderboard</h3>
  <p>Total Participants: <b id="participants">0</b></p>
  <ul id="leaderboardList"></ul>
</div>

<script>
/* ================= CONFIG ================= */

const BACKEND = "https://arc-quiz-dapp.onrender.com";
const QUESTIONS_PER_PAGE = 4;
const REWARD_PER_QUESTION = 0.2;

/* ================= STATE ================= */

let account = null;
let quiz = [];
let page = 1;
let totalEarned = 0;

/* ================= HELPERS ================= */

function truncate(addr) {
  return addr.slice(0, 6) + "..." + addr.slice(-4);
}

/* ================= LOAD BALANCE ================= */

async function loadBalance() {
  try {
    const r = await fetch(`${BACKEND}/balance`);
    const d = await r.json();
    document.getElementById("serverBalance").innerHTML =
      `Reward Pool: <b>${d.usdc} USDC</b><br>
       <small>Native Gas: ${d.native} USDC</small>`;
  } catch {
    document.getElementById("serverBalance").innerText =
      "Backend Connection Error";
  }
}

/* ================= LOAD QUIZ ================= */

async function loadQuiz() {
  const r = await fetch(`${BACKEND}/quiz`);
  quiz = await r.json();
  renderQuiz();
}

/* ================= RENDER QUIZ ================= */

function renderQuiz() {
  const start = (page - 1) * QUESTIONS_PER_PAGE;
  const end = Math.min(start + QUESTIONS_PER_PAGE, quiz.length);

  const box = document.getElementById("quiz");
  box.innerHTML = `<h3>Page ${page}</h3>`;

  quiz.slice(start, end).forEach((q, i) => {
    box.innerHTML += `
      <div class="quiz-box">
        <b>${q.question}</b><br><br>
        ${q.options.map(o => `
          <label>
            <input type="radio" name="q${start + i}" value="${o}">
            ${o}
          </label>
        `).join("<br>")}
      </div>
    `;
  });
}

/* ================= SUBMIT PAGE ================= */

document.getElementById("submitBtn").onclick = async () => {
  document.getElementById("submitBtn").disabled = true;

  const start = (page - 1) * QUESTIONS_PER_PAGE;
  const end = Math.min(start + QUESTIONS_PER_PAGE, quiz.length);

  for (let i = start; i < end; i++) {
    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    if (!selected) continue;

    if (selected.value === quiz[i].answer) {
      const r = await fetch(`${BACKEND}/reward`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userAddress: account,
          questionIndex: i
        })
      });

      const d = await r.json();
      if (d.success) totalEarned += REWARD_PER_QUESTION;
    }
  }

  page++;

  if ((page - 1) * QUESTIONS_PER_PAGE < quiz.length) {
    document.getElementById("submitBtn").disabled = false;
    renderQuiz();
  } else {
    showCompletion();
  }

  loadLeaderboard();
  loadBalance();
};

/* ================= COMPLETION ================= */

function showCompletion() {
  document.getElementById("quizSection").innerHTML = `
    <h2>üéâ Congratulations!</h2>
    <p>You have completed the Arc Quiz successfully.</p>
    <h3>Total Earned: <b>${totalEarned.toFixed(2)} USDC</b></h3>
    <p>Thanks for participating üöÄ</p>
  `;
}

/* ================= LEADERBOARD ================= */

async function loadLeaderboard() {
  const r = await fetch(`${BACKEND}/leaderboard`);
  const d = await r.json();

  document.getElementById("participants").innerText = d.participants;

  const list = document.getElementById("leaderboardList");
  list.innerHTML = "";

  d.leaderboard.slice(0, 10).forEach((e, i) => {
    list.innerHTML +=
      `<li>#${i + 1} ${truncate(e.address)} ‚Äî ${e.reward} USDC</li>`;
  });
}

/* ================= WALLET CONNECT ================= */

document.getElementById("connectBtn").onclick = async () => {
  if (!window.ethereum) {
    alert("Please install MetaMask");
    return;
  }

  const accs = await window.ethereum.request({
    method: "eth_requestAccounts"
  });

  account = accs[0];

  document.getElementById("status").innerText =
    "Connected: " + truncate(account);

  document.getElementById("connectBtn").disabled = true;
  document.getElementById("quizSection").style.display = "block";

  loadQuiz();
};

/* ================= INIT ================= */

loadBalance();
loadLeaderboard();
</script>
</body>
</html>
