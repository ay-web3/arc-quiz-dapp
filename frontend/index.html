<!DOCTYPE html>
<html>
<head>
  <title>Arc Quiz Rewards DApp</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

  <style>
    body {
      font-family: Poppins, sans-serif;
      background: #f4f6f8;
      padding: 30px;
    }
    .app {
      max-width: 700px;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    button {
      padding: 12px;
      width: 100%;
      margin-top: 10px;
      border-radius: 25px;
      background: #6a0dad;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      background: #bbb;
      cursor: not-allowed;
    }
    .quiz-box {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
<div class="app">
  <h2>Arc Reward Quiz</h2>

  <div id="serverBalance">Loading...</div>

  <button id="connectBtn">Connect Wallet</button>
  <p id="status">Disconnected</p>

  <div id="quizSection" style="display:none">
    <div id="quiz"></div>
    <button id="submitBtn">Submit Page</button>
  </div>

  <hr>
  <h3>üèÜ Leaderboard</h3>
  <p>Total Participants: <b id="participants">0</b></p>
  <ul id="leaderboardList"></ul>
</div>

<script>
/* ================= CONFIG ================= */

const BACKEND = "https://arc-quiz-dapp.onrender.com";
const QUESTIONS_PER_PAGE = 4;
const REWARD_PER_QUESTION = 0.2;

/* ================= STATE ================= */

let account;
let quiz = [];
let state;

/* ================= STORAGE ================= */

function storageKey() {
  return `arcQuiz_${account}`;
}

function loadState() {
  const saved = localStorage.getItem(storageKey());
  return saved ? JSON.parse(saved) : {
    page: 1,
    earned: 0,
    answered: [],
    completed: false
  };
}

function saveState() {
  localStorage.setItem(storageKey(), JSON.stringify(state));
}

/* ================= HELPERS ================= */

function truncate(a) {
  return a.slice(0, 6) + "..." + a.slice(-4);
}

/* ================= LOAD BALANCE ================= */

async function loadBalance() {
  const r = await fetch(`${BACKEND}/balance`);
  const d = await r.json();
  document.getElementById("serverBalance").innerHTML =
    `Reward Pool: <b>${d.usdc} USDC</b><br>
     <small>Native Gas: ${d.native} USDC</small>`;
}

/* ================= LOAD QUIZ ================= */

async function loadQuiz() {
  const r = await fetch(`${BACKEND}/quiz`);
  quiz = await r.json();

  if (state.completed) {
    showCompletion();
  } else {
    renderQuiz();
  }
}

/* ================= RENDER ================= */

function renderQuiz() {
  const start = (state.page - 1) * QUESTIONS_PER_PAGE;
  const end = Math.min(start + QUESTIONS_PER_PAGE, quiz.length);

  const box = document.getElementById("quiz");
  box.innerHTML = `<h3>Page ${state.page}</h3>`;

  quiz.slice(start, end).forEach((q, i) => {
    const idx = start + i;
    box.innerHTML += `
      <div class="quiz-box">
        <b>${q.question}</b><br><br>
        ${q.options.map(o => `
          <label>
            <input type="radio" name="q${idx}" value="${o}">
            ${o}
          </label>
        `).join("<br>")}
      </div>
    `;
  });

  document.getElementById("submitBtn").disabled = false;
}

/* ================= SUBMIT ================= */

document.getElementById("submitBtn").onclick = async () => {
  document.getElementById("submitBtn").disabled = true;

  const start = (state.page - 1) * QUESTIONS_PER_PAGE;
  const end = Math.min(start + QUESTIONS_PER_PAGE, quiz.length);

  for (let i = start; i < end; i++) {
    if (state.answered.includes(i)) continue;

    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    if (!selected) continue;

    if (selected.value === quiz[i].answer) {
      const r = await fetch(`${BACKEND}/reward`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ userAddress: account, questionIndex: i })
      });

      const d = await r.json();
      if (d.success) {
        state.earned += REWARD_PER_QUESTION;
        state.answered.push(i);
      }
    }
  }

  state.page++;
  saveState();

  if ((state.page - 1) * QUESTIONS_PER_PAGE < quiz.length) {
    renderQuiz();
  } else {
    state.completed = true;
    saveState();
    showCompletion();
  }

  loadLeaderboard();
  loadBalance();
};

/* ================= COMPLETE ================= */

function showCompletion() {
  document.getElementById("quizSection").innerHTML = `
    <h2>üéâ Congratulations!</h2>
    <p>You have completed the quiz.</p>
    <h3>Total Earned: <b>${state.earned.toFixed(2)} USDC</b></h3>
  `;
}

/* ================= LEADERBOARD ================= */

async function loadLeaderboard() {
  const r = await fetch(`${BACKEND}/leaderboard`);
  const d = await r.json();

  document.getElementById("participants").innerText = d.participants;

  const list = document.getElementById("leaderboardList");
  list.innerHTML = "";
  d.leaderboard.slice(0,10).forEach((e,i)=>{
    list.innerHTML += `<li>#${i+1} ${truncate(e.address)} ‚Äî ${e.reward} USDC</li>`;
  });
}

/* ================= CONNECT ================= */

document.getElementById("connectBtn").onclick = async () => {
  const accs = await window.ethereum.request({ method: "eth_requestAccounts" });
  account = accs[0];

  state = loadState();

  document.getElementById("status").innerText =
    "Connected: " + truncate(account);
  document.getElementById("connectBtn").disabled = true;
  document.getElementById("quizSection").style.display = "block";

  loadQuiz();
};

/* ================= INIT ================= */

loadBalance();
loadLeaderboard();
</script>
</body>
</html>
